<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super GPA Calc | Elite Academic Portal</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --primary: #0f172a;
            --accent: #2563eb;
            --success: #059669;
            --danger: #dc2626;
            --bg: #f8fafc;
            --card: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --sup-blue: #1e3a8a;
            --sup-light: #3b82f6;
            --warning-bg: #fffbeb;
        }

        * {
            box-sizing: border-box;
            font-family: 'Plus Jakarta Sans', sans-serif;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            background: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }

        /* --- AUTH SYSTEM --- */
        #authPage {
            display: flex;
            min-height: 100vh;
            width: 100%;
            background: #fff;
            overflow: hidden;
        }

        .auth-side {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 5%;
            width: 100%;
        }

        .branding-side {
            background: linear-gradient(135deg, var(--sup-blue) 0%, var(--sup-light) 100%);
            color: white;
            text-align: left;
            align-items: flex-start;
        }

        .branding-content {
            max-width: 480px;
        }

        .branding-content h1 {
            font-size: clamp(2rem, 5vw, 3rem);
            font-weight: 800;
            margin-bottom: 20px;
            line-height: 1.1;
            letter-spacing: -2px;
        }

        .p-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            margin-bottom: 15px;
        }

        .p-card h4 {
            margin: 0 0 5px 0;
            font-size: 14px;
        }

        .p-card p {
            margin: 0;
            font-size: 11px;
            opacity: 0.8;
        }

        .auth-input {
            width: 100%;
            padding: 16px;
            border: 2px solid var(--border);
            border-radius: 20px;
            outline: none;
            margin-bottom: 15px;
            font-size: 15px;
        }

        .auth-btn {
            width: 100%;
            padding: 18px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 20px;
            font-weight: 700;
            cursor: pointer;
            font-size: 16px;
        }

        .google-btn {
            width: 100%;
            padding: 14px;
            background: #fff;
            color: var(--text-main);
            border: 2px solid var(--border);
            border-radius: 20px;
            font-weight: 700;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .eye-toggle {
            position: absolute;
            right: 20px;
            bottom: 16px;
            cursor: pointer;
            color: var(--text-muted);
            font-size: 18px;
        }

        #authPage.register-mode {
            flex-direction: row-reverse;
        }

        /* --- DASHBOARD UI --- */
        #mainDashboard {
            display: none;
            padding: 40px 20px;
        }

        .container {
            max-width: 1250px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .glass-header {
            background: linear-gradient(135deg, var(--sup-blue) 0%, var(--sup-light) 100%);
            padding: 50px;
            border-radius: 45px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
            box-shadow: 0 35px 50px -15px rgba(30, 58, 138, 0.4);
        }

        .cgpa-val {
            font-size: clamp(40px, 8vw, 80px);
            font-weight: 800;
            letter-spacing: -4px;
        }

        .identity-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .id-card {
            background: white;
            padding: 25px 30px;
            border-radius: 25px;
            border: 1px solid var(--border);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.02);
        }

        .email-display {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #f1f5f9;
            padding: 12px 18px;
            border-radius: 18px;
            margin-top: 10px;
        }

        .actions-bar {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            background: #fff;
            padding: 12px;
            border-radius: 20px;
            border: 1px solid var(--border);
            width: fit-content;
        }

        .btn {
            padding: 12px 24px;
            border-radius: 14px;
            border: none;
            font-weight: 700;
            cursor: pointer;
            font-size: 13px;
        }

        .sem-card {
            background: white;
            border-radius: 40px;
            padding: clamp(20px, 4vw, 40px);
            border: 1px solid var(--border);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.03);
            margin-bottom: 30px;
        }

        .subject-block {
            background: #fcfcfd;
            border: 1.5px solid var(--border);
            border-radius: 30px;
            padding: 25px;
            margin-bottom: 25px;
            position: relative;
        }

        .mode-toggle {
            display: flex;
            background: #f1f5f9;
            padding: 5px;
            border-radius: 12px;
            width: fit-content;
        }

        .mode-btn {
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            background: transparent;
            color: var(--text-muted);
        }

        .mode-btn.active {
            background: white;
            color: var(--accent);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .table-wrap {
            overflow-x: auto;
            border-radius: 18px;
            background: white;
            margin-top: 15px;
            border: 1px solid var(--border);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 750px;
        }

        th {
            text-align: left;
            font-size: 11px;
            font-weight: 800;
            color: var(--text-muted);
            text-transform: uppercase;
            padding: 15px;
            border-bottom: 1px solid var(--border);
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #f1f5f9;
        }

        .input-minimal {
            width: 100%;
            padding: 10px;
            border: 1.5px solid var(--border);
            border-radius: 10px;
            outline: none;
            font-size: 13px;
        }

        .warning-banner {
            background: var(--warning-bg);
            color: #92400e;
            padding: 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 700;
            margin-bottom: 15px;
            border: 1px solid #fde68a;
        }

        .add-sem-area {
            border: 2px dashed var(--border);
            padding: 45px;
            border-radius: 35px;
            text-align: center;
            cursor: pointer;
            font-weight: 800;
            color: var(--text-muted);
            margin-bottom: 60px;
        }

        .add-sem-area:hover {
            border-color: var(--accent);
            color: var(--accent);
            background: white;
        }

        @media (max-width: 1024px) {
            #authPage {
                flex-direction: column !important;
            }

            .auth-side {
                padding: 40px 20px;
            }
        }
    </style>
</head>

<body>

    <div id="authPage">
        <div class="auth-side branding-side">
            <div class="branding-content">
                <h1>Super GPA Calc.</h1>
                <p>Advanced tracking for Superior students. Accurate ERP sync and modern assessments.</p>
                <div class="p-card">
                    <h4>‚ö° Quick Sync</h4>
                    <p>Import official result cards and PDF transcripts instantly.</p>
                </div>
                <div class="p-card">
                    <h4>üìä Precision Math</h4>
                    <p>Calculations strictly follow official portal grading logic.</p>
                </div>
                <div class="p-card">
                    <h4>‚òÅÔ∏è Cloud Sync</h4>
                    <p>Access your data on any device with secure cloud storage.</p>
                </div>
            </div>
        </div>
        <div class="auth-side form-side">
            <div class="form-container" id="loginForm">
                <h2 style="font-size: 32px; font-weight: 800; margin-bottom: 10px;">Sign In</h2>
                <input type="email" id="loginEmail" class="auth-input" placeholder="id@superior.edu.pk">
                <div class="input-group" style="position:relative"><input type="password" id="loginPass"
                        class="auth-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"><span class="eye-toggle"
                        onclick="togglePass('loginPass', this)">üëÅÔ∏è</span></div>
                <button class="auth-btn" onclick="handleAuth('login')">Login to Portal</button>
                <button class="google-btn" onclick="loginWithGoogle()">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="18"> Sign in
                    with Google
                </button>
                <p style="text-align: center; margin-top: 20px; font-size: 14px;">New? <span
                        onclick="toggleAuthMode('register')"
                        style="color:var(--accent); font-weight:800; cursor:pointer;">Register</span></p>
            </div>
            <div class="form-container" id="regForm" style="display: none;">
                <h2 style="font-size: 32px; font-weight: 800; margin-bottom: 10px;">Register</h2>
                <input type="email" id="regEmail" class="auth-input" placeholder="id@superior.edu.pk">
                <div class="input-group" style="position:relative"><input type="password" id="regPass"
                        class="auth-input" placeholder="Min. 6 chars"><span class="eye-toggle"
                        onclick="togglePass('regPass', this)">üëÅÔ∏è</span></div>
                <button class="auth-btn" style="background:var(--success)" onclick="handleAuth('signup')">Create
                    Account</button>
                <button class="google-btn" onclick="loginWithGoogle()">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="18"> Continue
                    with Google
                </button>
                <p style="text-align: center; margin-top: 20px; font-size: 14px;">Have account? <span
                        onclick="toggleAuthMode('login')"
                        style="color:var(--accent); font-weight:800; cursor:pointer;">Login</span></p>
            </div>
        </div>
    </div>

    <div id="mainDashboard">
        <div class="container">
            <div class="glass-header">
                <div>
                    <h1 style="margin:0; font-size: clamp(24px, 4vw, 36px);">Super GPA Calc</h1>
                    <p style="opacity: 0.8; font-size: clamp(14px, 2vw, 18px);">Superior University Performance System
                    </p>
                </div>
                <div style="text-align: right;">
                    <div
                        style="font-size: 11px; font-weight: 800; text-transform: uppercase; opacity: 0.8; letter-spacing: 1px;">
                        System CGPA</div>
                    <div id="cgpaVal" class="cgpa-val">0.00</div>
                    <div id="degreeStatus"
                        style="font-size:13px; font-weight:700; background:rgba(255,255,255,0.2); padding:8px 18px; border-radius:30px; margin-top:10px; display:inline-block;">
                        Credits: 0</div>
                </div>
            </div>

            <div class="identity-grid">
                <div class="id-card"><label
                        style="font-size:10px; font-weight:800; color:var(--text-muted); text-transform:uppercase;">Active
                        Student Email</label>
                    <div class="email-display"><span id="userEmailTag"
                            style="font-weight:700; color:var(--primary)">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span><span
                            style="cursor:pointer;" onclick="toggleEmailDisplay()">üëÅÔ∏è</span></div>
                </div>
                <div class="id-card"><label
                        style="font-size:10px; font-weight:800; color:var(--text-muted); text-transform:uppercase;">Account
                        Status</label>
                    <div style="color:var(--success); font-weight:700; margin-top:12px; font-size:16px;">‚úì Official
                        Access Verified</div>
                </div>
            </div>

            <div class="actions-bar">
                <button class="btn" style="background:var(--success); color:white"
                    onclick="document.getElementById('fileInput').click()">üìÅ Excel</button>
                <button class="btn" style="background:#6366f1; color:white"
                    onclick="document.getElementById('pdfInput').click()">üìÑ Sync PDF</button>
                <button class="btn" style="background:var(--danger); color:white" onclick="clearDashboard()">üóëÔ∏è
                    Clear</button>
                <button class="btn" style="background:#fff; border:1px solid var(--border)" onclick="logout()">üö™ Sign
                    Out</button>
                <input type="file" id="fileInput" accept=".xlsx, .xls, .csv" style="display:none">
                <input type="file" id="pdfInput" accept=".pdf" style="display:none">
            </div>

            <div id="semContainer"></div>
            <div class="add-sem-area" onclick="addSemester()">+ INITIALIZE NEW ACADEMIC SEMESTER BLOCK</div>
        </div>
    </div>

    <script>
        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyBQfE_ubdiP5DJSkvwLNHzptlNI85MK8ys",
            authDomain: "super-gpa-calc.firebaseapp.com",
            projectId: "super-gpa-calc",
            storageBucket: "super-gpa-calc.firebasestorage.app",
            messagingSenderId: "559503103274",
            appId: "1:559503103274:web:c0be6e61f637333ed93a53",
            measurementId: "G-S8CYBGS5SN"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        const gradingPlan = [
            { min: 85, g: "A", p: 4.00, c: "#059669" }, { min: 80, g: "A-", p: 3.66, c: "#10b981" },
            { min: 75, g: "B+", p: 3.33, c: "#2563eb" }, { min: 71, g: "B", p: 3.00, c: "#3b82f6" },
            { min: 68, g: "B-", p: 2.66, c: "#1d4ed8" }, { min: 64, g: "C+", p: 2.33, c: "#ea580c" },
            { min: 61, g: "C", p: 2.00, c: "#f59e0b" }, { min: 58, g: "C-", p: 1.66, c: "#d97706" },
            { min: 54, g: "D+", p: 1.30, c: "#92400e" }, { min: 50, g: "D", p: 1.00, c: "#78350f" },
            { min: 0, g: "F", p: 0.00, c: "#dc2626" }
        ];

        const assessmentTypes = ["Quiz", "Mid-Term", "Final", "Presentation", "Assignment", "Project", "Other"];

        let activeUser = null;
        let activeEmail = "";
        let semesterData = [];
        let isEmailVisible = false;

        // --- AUTH REDIRECT HANDLER (Critical for Mobile) ---
        auth.getRedirectResult().then((result) => {
            if (result && result.user) {
                if (result.user.email.endsWith('@superior.edu.pk')) {
                    activeUser = result.user;
                    activeEmail = result.user.email;
                    initDashboard();
                } else {
                    alert("Access Denied: Use @superior.edu.pk email only!");
                    auth.signOut();
                }
            }
        }).catch((error) => {
            console.error("Redirect Error:", error);
            if (error.code !== 'auth/unauthorized-domain') {
                alert("Mobile Login Error: " + error.message);
            }
        });

        // --- PDF/EXCEL IMPORT LOGIC ---
        async function handlePdfUpload(e) {
            const file = e.target.files[0]; if (!file) return;
            const pdf = await pdfjsLib.getDocument(new Uint8Array(await file.arrayBuffer())).promise;
            let fullText = "";
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                fullText += content.items.map(s => s.str).join(" ") + " ";
            }
            const sections = fullText.split(/Term:\s+/);
            sections.slice(1).forEach(section => {
                const words = section.trim().split(" ");
                const semester = { id: Date.now() + Math.random(), name: words[0] + " " + words[1], subjects: [] };
                const rowRegex = /(\d+)\s+([A-Z0-9]{6,12})\s+(.+?)\s+(\d\.\d{2})\s+(\d+)\s+(\d+)\s+([A-F][+-]?)/g;
                let m; while ((m = rowRegex.exec(section)) !== null) {
                    if (!m[3].includes("Course Title")) {
                        semester.subjects.push({
                            id: Date.now() + Math.random(), title: m[3].trim(), ch: parseFloat(m[4]),
                            simpleObt: parseFloat(m[6]), mode: 'simple',
                            assessments: [{ type: 'Final', weight: 100, total: 100, obt: parseFloat(m[6]) }]
                        });
                    }
                }
                if (semester.subjects.length > 0) semesterData.push(semester);
            });
            saveAndRender();
            alert("PDF Data Imported!");
        }

        // --- AUTH LOGIC ---
        function toggleAuthMode(m) { const p = document.getElementById('authPage'); if (m === 'register') { p.classList.add('register-mode'); document.getElementById('loginForm').style.display = 'none'; document.getElementById('regForm').style.display = 'block'; } else { p.classList.remove('register-mode'); document.getElementById('loginForm').style.display = 'block'; document.getElementById('regForm').style.display = 'none'; } }
        function togglePass(id, el) { const i = document.getElementById(id); i.type = i.type === "password" ? "text" : "password"; el.innerText = i.type === "password" ? "üëÅÔ∏è" : "üîí"; }
        function toggleEmailDisplay() { isEmailVisible = !isEmailVisible; document.getElementById('userEmailTag').innerText = isEmailVisible ? activeEmail : "‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"; }

        // 2. Handle Manual Auth: Isme maine Provider check dal diya hai
        async function handleAuth(t) {
            const e = document.getElementById(t === 'login' ? 'loginEmail' : 'regEmail').value.trim().toLowerCase();
            const p = document.getElementById(t === 'login' ? 'loginPass' : 'regPass').value;

            if (!e.endsWith('@superior.edu.pk')) return alert("Access Denied: @superior.edu.pk only!");
            if (p.length < 6) return alert("Password must be at least 6 characters.");

            try {
                if (t === 'signup') {
                    await auth.createUserWithEmailAndPassword(e, p);
                    alert("Account Created successfully! Now Login.");
                    toggleAuthMode('login');
                } else {
                    await auth.signInWithEmailAndPassword(e, p);
                }
            } catch (err) {
                // Agar account Google wala hai aur aap manual login kar rahe hain
                if (err.code === 'auth/invalid-credential' || err.code === 'auth/wrong-password') {
                    alert("Login Failed: Aapka account Google se linked hai. Meharbani karke 'Sign in with Google' button dabayein.");
                } else if (err.code === 'auth/email-already-in-use') {
                    alert("Ye Email pehle se register hai. Login page par ja kar Google button use karein.");
                } else {
                    alert(err.message);
                }
            }
        }

        // 3. Google Login: Mobile ke liye Redirect aur Desktop ke liye Popup
        async function loginWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            provider.setCustomParameters({
                prompt: 'select_account',
                hd: 'superior.edu.pk' // Sirf superior ki IDs select karne dega
            });

            try {
                if (window.innerWidth <= 768) {
                    // Mobile par popup block hota hai, isliye redirect use karein
                    await auth.signInWithRedirect(provider);
                } else {
                    const result = await auth.signInWithPopup(provider);
                    if (result.user.email.endsWith('@superior.edu.pk')) {
                        activeUser = result.user;
                        activeEmail = result.user.email;
                        initDashboard();
                    } else {
                        alert("Only @superior.edu.pk accounts allowed!");
                        await auth.signOut();
                    }
                }
            } catch (err) {
                alert("Google Auth Error: " + err.message);
            }
        }

        // Firebase Auth State Listener
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                if (!user.email.endsWith('@superior.edu.pk')) {
                    alert("Access Denied: Use @superior.edu.pk email only!");
                    await auth.signOut();
                    return;
                }
                activeUser = user;
                activeEmail = user.email;
                await initDashboard();
            } else {
                document.getElementById('authPage').style.display = 'flex';
                document.getElementById('mainDashboard').style.display = 'none';
                semesterData = [];
            }
        });

        async function initDashboard() {
            document.getElementById('authPage').style.display = 'none';
            document.getElementById('mainDashboard').style.display = 'block';
            const doc = await db.collection("users").doc(activeUser.uid).get();
            semesterData = doc.exists ? (doc.data().semesters || []) : [];
            render();
        }

        async function logout() { await auth.signOut(); location.reload(); }
        function clearDashboard() { if (confirm('Erase everything?')) { semesterData = []; saveAndRender(); } }

        async function saveAndRender() {
            if (activeUser) {
                try {
                    await db.collection("users").doc(activeUser.uid).set({
                        semesters: semesterData,
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                        email: activeEmail
                    }, { merge: true });
                    render();
                } catch (error) {
                    console.error("Cloud Sync Failed:", error);
                }
            }
        }

        // --- CORE LOGIC ---
        function addSemester() { semesterData.push({ id: Date.now(), name: `Semester ${semesterData.length + 1}`, subjects: [] }); saveAndRender(); window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' }); }
        function deleteSem(id) { semesterData = semesterData.filter(s => s.id !== id); saveAndRender(); }
        function addSubject(semId) { semesterData.find(s => s.id === semId).subjects.push({ id: Date.now() + Math.random(), title: '', ch: 3, simpleObt: 0, mode: 'simple', assessments: [{ type: 'Quiz', weight: 10, total: 40, obt: 0 }] }); saveAndRender(); }
        function switchMode(semId, subId, mode) { semesterData.find(s => s.id === semId).subjects.find(x => x.id === subId).mode = mode; saveAndRender(); }
        function updateAsm(semId, subId, asmIdx, field, val) { const sub = semesterData.find(s => s.id === semId).subjects.find(x => x.id === subId); sub.assessments[asmIdx][field] = field === 'type' ? val : parseFloat(val || 0); saveAndRender(); }

        function render() {
            const container = document.getElementById('semContainer');
            container.innerHTML = '';
            let totalQP = 0, totalCH = 0;

            semesterData.forEach((sem, sIdx) => {
                let semCH = 0, semQP = 0;
                const subjectsHtml = sem.subjects.map((sub, subIdx) => {
                    let weightedPercentage = 0, subTotalWeight = 0;
                    if (sub.mode === 'assessment') {
                        sub.assessments.forEach(a => { subTotalWeight += a.weight; if (a.total > 0) weightedPercentage += (a.obt / a.total) * a.weight; });
                    } else { weightedPercentage = sub.simpleObt || 0; }

                    const gradeObj = gradingPlan.find(p => weightedPercentage >= p.min) || gradingPlan[10];
                    semCH += sub.ch; semQP += (gradeObj.p * sub.ch);

                    const asmRows = sub.assessments.map((a, aIdx) => `
                    <tr>
                        <td>
                            <select class="input-minimal" onchange="updateAsm(${sem.id},${sub.id},${aIdx},'type',this.value)">
                                ${assessmentTypes.map(opt => `<option value="${opt}" ${a.type === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                            </select>
                        </td>
                        <td><input type="number" class="input-minimal" value="${a.weight}" onchange="updateAsm(${sem.id},${sub.id},${aIdx},'weight',this.value)"></td>
                        <td><input type="number" class="input-minimal" value="${a.total}" onchange="updateAsm(${sem.id},${sub.id},${aIdx},'total',this.value)"></td>
                        <td><input type="number" class="input-minimal" value="${a.obt}" onchange="updateAsm(${sem.id},${sub.id},${aIdx},'obt',this.value)"></td>
                        <td><button style="border:none; background:none; color:red; cursor:pointer;" onclick="semesterData.find(s=>s.id===${sem.id}).subjects.find(x=>x.id===${sub.id}).assessments.splice(${aIdx},1);saveAndRender()">‚úï</button></td>
                    </tr>`).join('');

                    return `
                <div class="subject-block">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; flex-wrap:wrap; gap:10px;">
                        <input style="font-weight:800; font-size:18px; border:none; outline:none; background:none; width:60%;" value="${sub.title}" placeholder="Subject Name" onchange="semesterData[${sIdx}].subjects[${subIdx}].title=this.value;saveAndRender()">
                        <div class="mode-toggle">
                            <button class="mode-btn ${sub.mode === 'simple' ? 'active' : ''}" onclick="switchMode(${sem.id},${sub.id},'simple')">Simple</button>
                            <button class="mode-btn ${sub.mode === 'assessment' ? 'active' : ''}" onclick="switchMode(${sem.id},${sub.id},'assessment')">Assessment</button>
                        </div>
                        <div><label style="font-size:10px; font-weight:800;">CH:</label><input type="number" style="width:45px" class="input-minimal" value="${sub.ch}" onchange="semesterData[${sIdx}].subjects[${subIdx}].ch=parseFloat(this.value);saveAndRender()"></div>
                    </div>
                    ${sub.mode === 'simple' ? `<div style="padding:10px 0;"><label style="font-size:10px; font-weight:800; color:var(--text-muted);">TOTAL OBTAINED MARKS (0-100)</label><input type="number" class="input-minimal" style="margin-top:8px;" value="${sub.simpleObt}" onchange="semesterData[${sIdx}].subjects[${subIdx}].simpleObt=parseFloat(this.value);saveAndRender()"></div>` : `
                        <div class="warning-banner" style="display: ${subTotalWeight !== 100 ? 'block' : 'none'}">‚ö†Ô∏è Total Weight: ${subTotalWeight}% (Target: 100%)</div>
                        <div class="table-wrap"><table><thead><tr><th>Type</th><th>Wtg %</th><th>Total</th><th>Obt</th><th></th></tr></thead><tbody>${asmRows}</tbody></table></div>
                        <button class="btn" style="background:#f1f5f9; color:var(--accent); font-weight:800; margin-top:15px;" onclick="semesterData.find(s=>s.id===${sem.id}).subjects.find(x=>x.id===${sub.id}).assessments.push({type:'Assignment',weight:10,total:40,obt:0});saveAndRender()">+ Add Assessment</button>
                    `}
                    <div style="display:flex; justify-content:flex-end; gap:20px; margin-top:20px; padding-top:15px; border-top:1px solid var(--border); font-weight:800;">
                        <span>Percentage: ${weightedPercentage.toFixed(1)}%</span>
                        <span style="color:var(--accent)">GPA: ${gradeObj.p.toFixed(2)}</span>
                        <button style="color:red; background:none; border:none; cursor:pointer;" onclick="semesterData[${sIdx}].subjects.splice(${subIdx},1);saveAndRender()">‚úï</button>
                    </div>
                </div>`;
                }).join('');

                const sgpa = semCH > 0 ? (semQP / semCH) : 0;
                totalCH += semCH; totalQP += semQP;
                const card = document.createElement('div'); card.className = 'sem-card';
                card.innerHTML = `<div class="sem-header"><div style="display:flex;align-items:center"><div style="background:var(--primary); color:white; width:40px; height:40px; display:flex; align-items:center; justify-content:center; border-radius:12px; font-weight:800">${sIdx + 1}</div><input style="font-size:20px; font-weight:800; border:none; outline:none; margin-left:15px; background:none;" value="${sem.name}" onchange="semesterData[${sIdx}].name=this.value;saveAndRender()"></div><div style="background:#eff6ff; color:var(--accent); padding:10px 20px; border-radius:15px; font-weight:800">SGPA: ${sgpa.toFixed(2)}</div><button style="color:var(--danger); background:none; border:none; cursor:pointer; font-weight:700" onclick="deleteSem(${sem.id})">Delete</button></div>
                ${subjectsHtml}<button class="auth-btn" style="width:100%; background:var(--bg); color:var(--accent); border:2px dashed var(--border); margin-top:10px;" onclick="addSubject(${sem.id})">+ ADD SUBJECT ENTRY</button>`;
                container.appendChild(card);
            });
            document.getElementById('cgpaVal').innerText = (totalCH > 0 ? (totalQP / totalCH) : 0).toFixed(2);
            document.getElementById('degreeStatus').innerText = `Total Earned Credits: ${totalCH}`;
        }

        document.getElementById('pdfInput').addEventListener('change', handlePdfUpload);
    </script>
</body>

</html>